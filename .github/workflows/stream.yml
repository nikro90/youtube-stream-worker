name: 24/7 YouTube Stream

on:
  # Manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      stream_duration:
        description: 'Duration in hours (max 5.5)'
        required: false
        default: '5.5'
      playlist_url:
        description: 'YouTube playlist URL to stream'
        required: false
        default: ''
  
  # Trigger from external API (Backend Repo A)
  repository_dispatch:
    types: [start-stream]
  
  # Auto-restart: runs every 6 hours
  schedule:
    - cron: '0 */6 * * *'

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 350  # 5 hours 50 minutes max
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg bc
          # Install yt-dlp
          sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
          sudo chmod a+rx /usr/local/bin/yt-dlp
          yt-dlp --version
      
      - name: Make script executable
        run: chmod +x stream-simple.sh
      
      - name: Run Stream
        env:
          YOUTUBE_STREAM_KEY: ${{ secrets.YOUTUBE_STREAM_KEY }}
          STREAM_URL: ${{ secrets.STREAM_URL || 'rtmp://a.rtmp.youtube.com/live2' }}
          PLAYLIST_URL: ${{ github.event.inputs.playlist_url || secrets.DEFAULT_PLAYLIST_URL || 'https://www.youtube.com/playlist?list=PLrAXtmErZgOeiKm4sgNOknGvNjby9efdf' }}
          STREAM_DURATION_HOURS: ${{ github.event.inputs.stream_duration || '5.5' }}
        run: ./stream-simple.sh
      
      - name: Trigger next stream cycle
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ”„ Triggering next stream cycle..."
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token $GITHUB_TOKEN" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type":"start-stream"}' || true
